<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type"  content="text/html; charset=UTF-8">  
    <script src="./jspsych.js"></script>
    <script src="./jspsych-html-button-response.js"></script>
    <script src="./jspsych-html-keyboard-response.js"></script>
    <script src="./jspsych-survey-text.js"></script>
    <script src="./platform.js"></script>
    <script src="../dist/jsQuestPlus.js"></script>
    <link rel="stylesheet" href="./jspsych.css">
    <style>
        .jspsych-display-element {
            display: inline;
        }
        div.instruction {
            width: 600px;
            text-align: left;
        }
    </style>

  </head>
  <body></body>
  <script>
    function example1(){
        // Example: 1 stimulus parameter x 1 PF parameter x 2 responses
        // Estimation of contrast threshold {1, 1, 2} in Watson (2017)

        output = {}
        function func_resp0(stim, threshold, slope, guess, lapse) {
            return jsQuestPlus.weibull(stim, threshold, slope, guess, lapse) 
        }

        // Psychometric function corresponding to the second response (response = 1).
        function func_resp1(stim, threshold, slope, guess, lapse) {
            return 1 - func_resp0(stim, threshold, slope, guess, lapse) 
        }

        const true_slope = 3.5
        const true_guess = 0.5
        const true_lapse = 0.02

        const contrast_samples = jsQuestPlus.linspace(-40, 0) // [-40, -39, -38, ..., -1, 0]
        const threshold_samples = jsQuestPlus.linspace(-40,0) // [-40, -39, -38, ..., -1, 0]
        const slope_samples = [true_slope] // Don't forget to add brackets, i.e., specify as an array.
        const guess = [true_guess]
        const lapse_samples = [true_lapse]

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        const jsqp = new jsQuestPlus(
            [func_resp0, func_resp1], [contrast_samples], [threshold_samples, slope_samples, guess, lapse_samples])
        const init_time = performance.now() - base_time

        output['jsqp'] = jsqp
        output['finish_func'] = function(data){
            function simulate_observer(contrast){
                const true_threshold = -20
                if (Math.random() > func_resp0(contrast, true_threshold, true_slope, true_guess, true_lapse)){
                    return 1 // yes
                } else {
                    return 0 // no
                }
            }

            const base_time1 = performance.now();    
            const stim = jsqp.getStimParams()
            const getStimParams_time = performance.now() - base_time1

            const resp = simulate_observer(stim) 

            const base_time2 = performance.now();
            jsqp.update(stim, resp)
            const update_time = performance.now() - base_time2

            data['getStimParams_time'] = getStimParams_time
            data['update_time'] = update_time
            data['init_time'] = init_time
            data['samples'] = calc_samples(jsqp)

        }
        return output
    }

    function example2(){
        // Example: 1 stimulus parameter x 3 PF parameters x 2 responses
        // Estimation of contrast threshold, slope, and lapse {1, 3, 2} in Watson (2017)

        output = {}
        function func_resp0(stim, threshold, slope, guess, lapse) {
            return jsQuestPlus.weibull(stim, threshold, slope, guess, lapse) 
        }
        function func_resp1(stim, threshold, slope, guess, lapse) {
            return 1 - func_resp0(stim, threshold, slope, guess, lapse) 
        }

        const true_guess = 0.5

        const contrast_samples = jsQuestPlus.linspace(-40, 0) // [-40, -39, -38, ..., -1, 0]
        const threshold_samples = jsQuestPlus.linspace(-40,0) // [-40, -39, -38, ..., -1, 0]
        const slope_samples = jsQuestPlus.linspace(2,5) // [2, 3, 4, 5]
        const guess = [true_guess]
        const lapse_samples = jsQuestPlus.array(0, 0.01, 0.04) // [0, 0.01, 0.02, 0.03, 0.04]

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        const jsqp = new jsQuestPlus(
            [func_resp0, func_resp1], [contrast_samples], [threshold_samples, slope_samples, guess, lapse_samples])
        const init_time = performance.now() - base_time

        output['jsqp'] = jsqp
        output['finish_func'] = function(data){
            function simulate_observer(contrast){
                const true_threshold = -20
                const true_slope = 3
                const true_lapse = 0.02

                if (Math.random() > func_resp0(contrast, true_threshold, true_slope, true_guess, true_lapse)){
                    return 1 // yes
                } else {
                    return 0 // no
                }
            }

            const base_time1 = performance.now();    
            const stim = jsqp.getStimParams()
            const getStimParams_time = performance.now() - base_time1

            const resp = simulate_observer(stim) 

            const base_time2 = performance.now();
            jsqp.update(stim, resp)
            const update_time = performance.now() - base_time2

            data['getStimParams_time'] = getStimParams_time
            data['update_time'] = update_time
            data['init_time'] = init_time
            data['samples'] = calc_samples(jsqp)

        }
        return output
    }

    function example4(){
        // Example: 2 stimulus parameters x 3 PF parameters x 2 responses
        // Contrast sensitivity function {2, 3, 2} in Watson (2017)

        output = {}
        function func_resp0(freq, contrast, threshold, c0, cf){
            const max = Math.max(threshold, c0 + cf*freq)
            return jsQuestPlus.weibull(contrast, max, 3, 0.5, 0.01)
        }
        function func_resp1(freq, contrast, threshold, c0, cf){
            return 1 - func_resp0(freq, contrast, threshold, c0, cf) 
        }

        const spatial_frequency = jsQuestPlus.array(0, 2, 40)
        const contrast = jsQuestPlus.array(-50, 2, 0)
        const threshold = jsQuestPlus.array(-50, 2, -30)
        const c0 = jsQuestPlus.array(-60, 2, -40)
        const cf = jsQuestPlus.array(0.8, 0.2, 1.6)

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        const jsqp = new jsQuestPlus([func_resp0, func_resp1], [spatial_frequency, contrast], [threshold, c0, cf])
        const init_time = performance.now() - base_time

        output['jsqp'] = jsqp
        output['finish_func'] = function(data){

            function simulate_observer(freq, contrast){
                const true_threshold = -35
                const true_c0 = -50
                const true_cf = 1.2

                if (Math.random() > func_resp0(freq, contrast, true_threshold, true_c0, true_cf)){
                    return 1 // yes
                } else {
                    return 0 // no
                }
            }

            const base_time1 = performance.now();    
            const stim = jsqp.getStimParams()
            const getStimParams_time = performance.now() - base_time1

            const resp = simulate_observer(stim[0], stim[1]) 

            const base_time2 = performance.now();
            jsqp.update(stim, resp)
            const update_time = performance.now() - base_time2

            data['getStimParams_time'] = getStimParams_time
            data['update_time'] = update_time
            data['init_time'] = init_time
            data['samples'] = calc_samples(jsqp)
        }

        return output
    }

    function example5(){
        // Example: 3 stimulus parameters x 4 PF parameters x 2 responses
        // Spatiotemporal contrast sensitivity {3, 4, 2} in Watson (2017)

        output = {}
        function func_resp0(contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw){
            const max = Math.max(threshold, c0 + cf*spatial_freq + cw*temporal_freq)
            return jsQuestPlus.weibull(contrast, max, 3, 0.5, 0.01)
        }
        function func_resp1(contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw){
            return 1 - func_resp0(contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw)
        }

        const contrast = jsQuestPlus.array(-40, 5, 0)       
        const spatial_freq = jsQuestPlus.array(0, 5, 40)
        const temporal_freq = jsQuestPlus.array(0, 5, 40)
        const threshold = jsQuestPlus.array(-50, 5, -30)
        const c0 = jsQuestPlus.array(-60, 5, -40)
        const cf = jsQuestPlus.array(0.8, 0.2, 1.6)
        const cw = jsQuestPlus.array(0.8, 0.2, 1.6)

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        const jsqp = new jsQuestPlus([func_resp0, func_resp1], [contrast, spatial_freq, temporal_freq], [threshold, c0, cf, cw])
        const init_time = performance.now() - base_time

        output['jsqp'] = jsqp
        output['finish_func'] = function(data){
            function simulate_observer(contrast, spatial_freq, temporal_freq){
                const true_threshold = -40
                const true_c0 = -50
                const true_cf = 1.2
                const true_cw = 1.0

                if (Math.random() > func_resp0(contrast, spatial_freq, temporal_freq, true_threshold, true_c0, true_cf, true_cw)){
                    return 1 // yes
                } else {
                    return 0 // no
                }
            }

            const base_time1 = performance.now();    
            const stim = jsqp.getStimParams()
            const getStimParams_time = performance.now() - base_time1

            const resp = simulate_observer(stim[0], stim[1], stim[2]) 

            const base_time2 = performance.now();
            jsqp.update(stim, resp)
            const update_time = performance.now() - base_time2

            data['getStimParams_time'] = getStimParams_time
            data['update_time'] = update_time
            data['init_time'] = init_time
            data['samples'] = calc_samples(jsqp)
        }
        return output
    }

    const ex1 = example1()
    const ex2 = example2()
    const ex4 = example4()
    const ex5 = example5()

    const simulation = []
    const instruction = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>We have developed a tool named jsQuestPlus to measure thresholds in online experiments.</p>
            <p>This survey is to check if jsQuestPlus works well on your computer.</p>
            <p>You don't need to answer any questions, but we will record information about your computer model, operating system (Windows, Mac, etc.), and web browser (Edge, Safari, Chrome, etc.).</p>
            <p>We will not obtain any information that will identify you personally, but will record information such as "How many seconds did jsQuestPlus run on Windows Chrome" for example. 
                We will also publish statistics based on the data in a paper.</p>
            <p>Nothing will be installed on your computer.</p>
            <p>If you agree to cooperate with the survey, please click the "Continue" button.</p>
            </div>`,
        choices: ['Continue'],
    }

    simulation.push(instruction)

    const conditions = [ex1, ex2, ex4, ex5]
    const nTrials = [32, 64, 32, 64]
    conditions.forEach((condition, index) =>{
        for (let i = 0; i < nTrials[index]; i++){
            const trial = {
                type: 'html-keyboard-response',
                stimulus: function(){
                    // const progress = Math.round(trial_num/simulated_answers.length * 100)
                    const progress = 100
                    return `<p>The program is running. It will finish in about 30 seconds.</p>
                    <p>Please wait as the screen will automatically change.</p>
                    <p>The progress of the program will be indicated by the bar at the top of the screen.</p>
                    <p>If you run into errors, please let us know.</p>`},
                choices: ['jsPsych.NO_KEYS'],
                data: {Trial: i+1},
                trial_duration: 100,
                on_finish: condition.finish_func
            }
            simulation.push(trial)
        }
    })

    function calc_samples(jsqp){
        return jsqp.comb_stim_params.length * jsqp.comb_PF_params.length * jsqp.responses.length
    }


    const briefing = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>The survey has been completed. Thank you very much for your cooperation.</p>
            <p>You can close this window.</p>
            <p>If you are interested in jsQuestPlus, see <a href="https://github.com/kurokida/jsQuestPlus">this page</a>in detail.</p>
            </div>`,
        on_start: function(trial){
            const myrandID = jsPsych.randomization.randomID(8);
            const ex1_estimates = ex1.jsqp.getEstimates()
            const ex2_estimates = ex2.jsqp.getEstimates()
            const ex4_estimates = ex4.jsqp.getEstimates()
            const ex5_estimates = ex5.jsqp.getEstimates()

    
            jsPsych.data.addProperties({
                date: getDateStr(),
                ID: myrandID,
                appName: navigator.appName,
                vendor: navigator.vendor,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                platform_name: platform.name,
                platform_version: platform.version,
                platform_layout: platform.layout,
                architecture: platform.os.architecture,
                family: platform.os.family,
                os_version: platform.os.version,
                os: platform.os.toString(),
                description: platform.description,
                product: platform.product,
                ex1_threshold: ex1_estimates[0],
                ex2_threshold: ex2_estimates[0],
                ex2_slope: ex2_estimates[1],
                ex2_lapse: ex2_estimates[3],
                ex4_threshold: ex4_estimates[0],
                ex4_c0: ex4_estimates[1],
                ex4_cf: ex4_estimates[2],
                ex5_threshold: ex5_estimates[0],
                ex5_c0: ex5_estimates[1],
                ex5_cf: ex5_estimates[2],
                ex5_cw: ex5_estimates[3],
                ex1_nAlerts: ex1.jsqp.nAlerts,
                ex2_nAlerts: ex1.jsqp.nAlerts,
                ex4_nAlerts: ex1.jsqp.nAlerts,
                ex5_nAlerts: ex1.jsqp.nAlerts,
            })

            // saveData()
            jsPsych.data.get().ignore('stimulus').localSave('csv','mydata.csv');
        },
        choices: ['Finish']
    }
    simulation.push(briefing)

    function saveData() {
        var xhr = new XMLHttpRequest();
        // xhr.open('POST', 'write_data.php'); // change 'write_data.php' to point to php script.
        xhr.open('POST', 'jsqp_write_data.php', false); // Need to specify false to save data with iPhone or iPad
        // https://github.com/jspsych/jsPsych/issues/1999#issuecomment-883748620

        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if(xhr.status == 200){
                var response = JSON.parse(xhr.responseText);
                console.log(response.success);
            }
        };
        xhr.onerror = function(){
            alert('Err')
            alert(`Error ${xhr.status}: ${xhr.statusText}: ${xhr.responseXML}`); 
        }
        xhr.send(jsPsych.data.get().json());
    }

    jsPsych.init({
        timeline: simulation,
        show_progress_bar: true,
        message_progress_bar: 'Progress bar',
        on_finish: function(){
            // jsPsych.data.displayData(); 
        },
    });

    function getDateStr(){
        const now = new Date();
        const year = now.getFullYear();
        let month = now.getMonth() + 1; // Month
        let day = now.getDate(); // Day
        let hour = now.getHours(); // Hour
        let minute = now.getMinutes(); // Minute
        let sec = now.getSeconds(); // Second
        if(month < 10) { month = "0" + month; }
        if(day < 10) { day = "0" + day; }
        if(hour < 10) { hour = "0" + hour; }
        if(minute < 10) { minute = "0" + minute; }
        if(sec < 10) { sec = "0" + sec; }

        return year + '-' + month + '-' + day + '-' + hour + ':' + minute + ':' + sec;
    }
  </script>
</html>
